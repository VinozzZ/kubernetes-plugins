# Go
# Build your Go project.
# Add steps that test, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/go

trigger:
  branches:
    include:
      - refs/heads/main
      - refs/tags/*

pool:
  vmImage: 'Ubuntu 18.04'

variables:
  GOVERSION: "1.14.6"

jobs:
  - job: build
    displayName: "Build"
    steps:
    - task: GoTool@0
      inputs:
        version: "$(GOVERSION)"
      displayName: 'Install Go'

    - script: |
        set -xeuo pipefail
        mkdir -p /home/vsts/go/bin/
        echo "##vso[task.prependpath]/home/vsts/go/bin/"
      displayName: 'Configure Go'

    - script: |
        make build
      workingDirectory: '$(System.DefaultWorkingDirectory)'
      displayName: 'Build'

    - script: |
        make test-unit
      workingDirectory: '$(System.DefaultWorkingDirectory)'
      displayName: 'Unit Test'

    - task: PublishPipelineArtifact@0
      displayName: "Publish Native Binaries"
      inputs:
        targetPath: $(System.DefaultWorkingDirectory)/bin
        archiveFilePatterns: "**"
        artifactName: "build-bin"

  - job: integration_test
    displayName: "Integration Test"
    dependsOn: build
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: "Download Bin"
      inputs:
        source: current
        artifact: build-bin
        path: bin
    - task: GoTool@0
      displayName: "Set Go Version"
      inputs:
        version: "$(GOVERSION)"
    - bash: ./build/run-integration-tests.sh
      displayName: "Integration Test"
